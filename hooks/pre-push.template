#!/usr/bin/env sh

echo "ğŸš€ PRE-PUSH VALIDATION STARTING..."

# Navigate to project root if needed
if [ -f "package.json" ]; then
    PROJECT_ROOT="."
else
    # Try to find package.json in parent directories
    PROJECT_ROOT=$(find . -maxdepth 3 -name "package.json" -exec dirname {} \; | head -1)
    if [ -n "$PROJECT_ROOT" ]; then
        cd "$PROJECT_ROOT"
        echo "Found project root at: $(pwd)"
    else
        echo "âŒ Cannot find package.json - make sure you're in a Node.js project"
        exit 1
    fi
fi

# Run tests if test script exists
echo "ğŸ§ª Running tests..."
if npm run test --if-present; then
    echo "âœ… Tests passed"
else
    echo "âŒ Tests failed - blocking push"
    exit 1
fi

# Run comprehensive security scan
echo "ğŸ›¡ï¸ Running comprehensive security scan..."
if npm run security:full; then
    echo "âœ… Security scan passed"
else
    echo "âŒ Security scan failed - blocking push"
    exit 1
fi

# Run Snyk IaC scan if Docker/IaC files present and enterprise preset
if [ "{{PRESET}}" = "enterprise" ]; then
    echo "ğŸ—ï¸ Checking for Infrastructure as Code files..."
    if find . -name "Dockerfile*" -o -name "docker-compose*.yml" -o -name "*.tf" | grep -q .; then
        echo "ğŸ” Running Snyk Infrastructure as Code scan..."
        if npm run security:snyk-iac; then
            echo "âœ… IaC scan passed"
        else
            echo "âš ï¸ IaC scan found issues, but continuing..."
        fi
    else
        echo "â„¹ï¸ No IaC files found, skipping IaC scan"
    fi
fi

# Run build to ensure everything compiles
echo "ğŸ—ï¸ Running build..."
if npm run build --if-present; then
    echo "âœ… Build successful"
else
    echo "âŒ Build failed - blocking push"
    exit 1
fi

echo "âœ… All pre-push validations passed! Safe to push."