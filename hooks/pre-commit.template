#!/usr/bin/env sh

echo "ğŸ” PRE-COMMIT SECURITY CHECKS STARTING..."
echo "Current directory: $(pwd)"

# Navigate to project root if needed
if [ -f "package.json" ]; then
    PROJECT_ROOT="."
else
    # Try to find package.json in parent directories
    PROJECT_ROOT=$(find . -maxdepth 3 -name "package.json" -exec dirname {} \; | head -1)
    if [ -n "$PROJECT_ROOT" ]; then
        cd "$PROJECT_ROOT"
        echo "Found project root at: $(pwd)"
    else
        echo "âŒ Cannot find package.json - make sure you're in a Node.js project"
        exit 1
    fi
fi

# Run lint-staged for code quality
echo "ğŸ“ Running lint-staged..."
if npx lint-staged; then
    echo "âœ… Code formatting and linting passed"
else
    echo "âŒ Code formatting or linting failed"
    exit 1
fi

# Run security audit
echo "ğŸ”’ Running security audit..."
if npm run security:audit; then
    echo "âœ… Security audit passed"
else
    echo "âŒ Security audit found vulnerabilities"
    exit 1
fi

# Run Snyk scan for standard/enterprise presets
if [ "{{PRESET}}" != "basic" ]; then
    echo "ğŸ” Running Snyk dependency scan..."
    if npm run security:snyk; then
        echo "âœ… Snyk dependency scan passed"
    else
        echo "âŒ Snyk dependency scan found vulnerabilities"
        exit 1
    fi

    # Run Snyk code analysis (if available)
    echo "ğŸ” Running Snyk code analysis..."
    if npm run security:snyk-code 2>/dev/null; then
        echo "âœ… Snyk code analysis passed"
    else
        echo "â„¹ï¸ Snyk code analysis not available (requires paid plan) or no issues found"
    fi
fi

echo "âœ… All pre-commit security checks passed!"